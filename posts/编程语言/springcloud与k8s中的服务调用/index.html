<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringCloud与K8S中的服务调用 | luanrz's blog</title><meta name=keywords content="Java,Spring"><meta name=description content="微服务中的服务调用至少需要考虑以下几个方面：

服务注册：动态存储服务的访问地址
服务发现：动态获取服务的访问地址
负载均衡：按照一定的规则获取同一服务的不同实例

它们在SpringCloud和K8S中有着不同的实现方式："><meta name=author content><link rel=canonical href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8/><link crossorigin=anonymous href=/assets/css/stylesheet.ed6c30fee125be816b653632a2732f92313b593583d98576c9eb2bf33a42b6e1.css integrity="sha256-7Www/uElvoFrZTYyonMvkjE7WTWD2YV2yesr8zpCtuE=" rel="preload stylesheet" as=style><link rel=icon href=https://luanrz.github.io/images/icon.jpg><link rel=icon type=image/png sizes=16x16 href=https://luanrz.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://luanrz.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://luanrz.github.io/apple-touch-icon.png><link rel=mask-icon href=https://luanrz.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>const loadScript=(e,t)=>{var n=document.createElement("script");n.onerror=e=>{throw new URIError("The script "+e.target.src+" didn't load correctly.")},t&&(n.onload=t),document.head.insertAdjacentElement("beforeend",n),n.src=e},loadPlantUMLOnNeed=()=>{let e="language-plantuml";document.querySelectorAll("[class^="+e+"]").length>0&&loadScript("https://fastly.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js",()=>{(function(){Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.insertBefore(t,e),e.style.display="none"})})(),console.log("PlantUML init done")})};window.addEventListener("load",function(){loadPlantUMLOnNeed()})</script><meta property="og:url" content="https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8/"><meta property="og:site_name" content="luanrz's blog"><meta property="og:title" content="SpringCloud与K8S中的服务调用"><meta property="og:description" content="微服务中的服务调用至少需要考虑以下几个方面：
服务注册：动态存储服务的访问地址 服务发现：动态获取服务的访问地址 负载均衡：按照一定的规则获取同一服务的不同实例 它们在SpringCloud和K8S中有着不同的实现方式："><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-08T10:19:50+08:00"><meta property="article:modified_time" content="2023-05-08T10:19:50+08:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="Spring"><meta name=twitter:card content="summary"><meta name=twitter:title content="SpringCloud与K8S中的服务调用"><meta name=twitter:description content="微服务中的服务调用至少需要考虑以下几个方面：

服务注册：动态存储服务的访问地址
服务发现：动态获取服务的访问地址
负载均衡：按照一定的规则获取同一服务的不同实例

它们在SpringCloud和K8S中有着不同的实现方式："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luanrz.github.io/posts/"},{"@type":"ListItem","position":3,"name":"SpringCloud与K8S中的服务调用","item":"https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringCloud与K8S中的服务调用","name":"SpringCloud与K8S中的服务调用","description":"微服务中的服务调用至少需要考虑以下几个方面：\n服务注册：动态存储服务的访问地址 服务发现：动态获取服务的访问地址 负载均衡：按照一定的规则获取同一服务的不同实例 它们在SpringCloud和K8S中有着不同的实现方式：\n","keywords":["Java","Spring"],"articleBody":"微服务中的服务调用至少需要考虑以下几个方面：\n服务注册：动态存储服务的访问地址 服务发现：动态获取服务的访问地址 负载均衡：按照一定的规则获取同一服务的不同实例 它们在SpringCloud和K8S中有着不同的实现方式：\nSpringCloud K8S 服务注册与服务发现 注册中心（Erueka、Nacos等） Service（kube-dns） 负载均衡 负载均衡组件（Ribbon、SpringCloudLoadBalancer等） Service（kube-proxy等） 下面将结合代码分别介绍SpinrgCloud与K8S中服务注册、服务发现、负载均衡的过程。\n一、SpringCloud中的服务注册与服务发现 （一）SpringCloud服务注册与服务发现编程模型 SpringCloud在SpringCloudCommons模块中定义了服务注册与服务发现的抽象层，如下：\n服务注册接口ServiceRegistry 服务发现接口DiscoveryClient 在maven依赖中引入Eureka或Nacos后，将会基于SpringBoot的工厂加载机制自动加载上述接口的实现：\n服务注册接口ServiceRegistry的实现：EurekaServiceRegistry、NacosServiceRegistry 服务发现接口DiscoveryClient的实现：NacosDiscoveryClient、NacosDiscoveryClient、CompositeDiscoveryClient、SimpleDiscoveryClient 由于组件注入时使用的是ServiceRegistry与DiscoveryClient这两个抽象接口，因此，无须修改代码即可实现不同注册中心的无缝切换，只需要替换maven依赖与对应的注册中心的配置即可。\n下面将基于Nacos演示一下服务注册与服务发现的用法（Eureka的用法完全一致）。\n（二）Nacos注册中心服务 根据Nacos官网步骤启动Nacos注册中心。\n访问http://127.0.0.1:8848进入Nacos首页。\n（三）Nacos服务提供者 在pom.xml中引入nacos-discovery依赖：\ncom.alibaba.cloud spring-cloud-starter-alibaba-nacos-discovery 在application.properties（或application.yml）中引入nacos相关配置：\nserver.port=8081 spring.application.name=nacos-provider spring.cloud.nacos.discovery.username=nacos spring.cloud.nacos.discovery.password=nacos spring.cloud.nacos.discovery.server-addr=localhost:8848 spring.cloud.nacos.discovery.namespace=public 定义应用入口并暴露一个服务：\n@SpringBootApplication public class NacosProviderApplication { public static void main(String[] args) { SpringApplication.run(NacosProviderApplication.class, args); } @RestController class EchoController { @GetMapping(\"/echo\") public String echo(HttpServletRequest request) { return \"echo:\" + request.getParameter(\"name\"); } } } 上述代码详见github\n启动应用后，该服务将自动注册到Nacos注册中心。查看注册中心中该服务的状态：\ncurl -X GET 'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos-provider' 正常返回如下：\n{\"name\":\"DEFAULT_GROUP@@nacos-provider\",\"groupName\":\"DEFAULT_GROUP\",\"clusters\":\"\",\"cacheMillis\":10000,\"hosts\":[{\"ip\":\"172.26.2.233\",\"port\":8081,\"weight\":1.0,\"healthy\":true,\"enabled\":true,\"ephemeral\":true,\"clusterName\":\"DEFAULT\",\"serviceName\":\"DEFAULT_GROUP@@nacos-provider\",\"metadata\":{\"preserved.register.source\":\"SPRING_CLOUD\",\"IPv6\":\"[fc00:f853:ccd:e793:0:0:0:1]\"},\"instanceHeartBeatInterval\":5000,\"instanceHeartBeatTimeOut\":15000,\"ipDeleteTimeout\":30000}],\"lastRefTime\":1683528099856,\"checksum\":\"\",\"allIPs\":false,\"reachProtectionThreshold\":false,\"valid\":true} （四）Nacos服务消费者 在pom.xml中引入与Nacos服务提供者一样的nacos-discovery依赖。\ncom.alibaba.cloud spring-cloud-starter-alibaba-nacos-discovery 在application.properties（或application.yml）中引入nacos相关配置。除了端口和服务名外，其它配置与Nacos服务提供者完全一致。\nserver.port=8080 spring.application.name=nacos-consumer spring.cloud.nacos.discovery.username=nacos spring.cloud.nacos.discovery.password=nacos spring.cloud.nacos.discovery.server-addr=localhost:8848 spring.cloud.nacos.discovery.namespace=public 在代码中通过DiscoveryClient获取Nacos服务提供者的实例地址，通过RestTemplate访问。并使用@EnableDiscoveryClient(autoRegister = false)以避免将服务消费者注册到注册中心。\n@SpringBootApplication @EnableDiscoveryClient(autoRegister = false) public class NacosConsumerApplication { public static void main(String[] args) { SpringApplication.run(NacosConsumerApplication.class, args); } @Bean public RestTemplate restTemplate() { return new RestTemplate(); } @RestController class HelloController { @Autowired private DiscoveryClient discoveryClient; @Autowired private RestTemplate restTemplate; private String serviceName = \"nacos-provider\"; @GetMapping(\"/services\") public String info() { String serviceInfo = discoveryClient.getServices().toString(); String instanceInfo = discoveryClient.getInstances(serviceName).stream().map(instance -\u003e \"InstanceId: \" + instance.getInstanceId() + \"\nServiceId: \" + instance.getServiceId() + \"\nHost: \" + instance.getHost() + \"\nPort: \" + instance.getPort() + \"\n\").collect(Collectors.joining()); return serviceInfo + \"\n\" + instanceInfo; } @GetMapping(\"/hello\") public String hello() { List\u003cServiceInstance\u003e instances = discoveryClient.getInstances(serviceName); ServiceInstance serviceInstance = instances.stream().findAny().orElseThrow(() -\u003e new IllegalStateException(\"no \" + serviceName + \" instance available\")); return restTemplate.getForObject(\"http://\" + serviceInstance.getHost() + \":\" + serviceInstance.getPort() + \"/echo?name=nacos\",String.class); } } } 上述代码详见github\n启动应用后，访问对应服务：\ncurl -X GET 'http://127.0.0.1:8080/hello?name=nacos' 正常返回如下：\necho:nacos 二、SpringCloud中的负载均衡 （一）SpringCloud负载均衡编程模型 SpringCloud在SpringCloudCommons模块中定义了负载均衡的抽象层：LoadBalancerClient与LoadBalanced。\nLoadBalancerClient的实现有：基于Ribbon的RibbonLoadBalancerClient、基于SpringCloudLoadBalancer的BlockingLoadBalancerClient。\n（二）基于@LoadBalanced注解与Feign组件实现客户端负载均衡 在pom.xml中引入Feign、服务发现与负载均衡的依赖。\norg.springframework.cloud spring-cloud-starter-openfeign com.alibaba.cloud spring-cloud-starter-alibaba-nacos-discovery org.springframework.cloud spring-cloud-starter-loadbalancer 在application.properties（或application.yml）中引入nacos相关配置。该配置与Nacos服务消费者完全一致。\nserver.port=8080 spring.application.name=open-feign spring.cloud.nacos.discovery.username=nacos spring.cloud.nacos.discovery.password=nacos spring.cloud.nacos.discovery.server-addr=localhost:8848 spring.cloud.nacos.discovery.namespace=public 定义Feign服务。\n@FeignClient(name = \"nacos-provider\") // url = \"http://localhost:8081\" interface EchoApi { @GetMapping(\"/echo\") String echo(@RequestParam(\"name\") String name); } 定义应用入口。\n@EnableFeignClients @SpringBootApplication public class OpenFeignApplication { public static void main(String[] args) { SpringApplication.run(OpenFeignApplication.class, args); } @RestController class HelloController { @Autowired EchoApi echoApi; @GetMapping(\"/hello\") public String hello() { return echoApi.echo(\"nacos\"); } } } 上述代码详见github\n停止Nacos服务提供者与Nacos服务消费者两个应用。随后启动三个Nacos服务提供者应用（修改server.port环境变量），再启动当前应用，验证负载均衡效果。\ncurl -X GET 'http://127.0.0.1:8080/hello?name=nacos' 正常返回如下：\necho:nacos 查看三个Nacos服务提供者的控制台日志，多次调用会在不同的应用控制台显示相关信息。\n三、K8S中的服务注册、服务发现与负载均衡 K8S通过Service对象定义一个服务，一旦Service定义成功，就自动支持了服务注册、服务发现与负载均衡。Service可以基于Pod、Deployment、另外一个Service等对象对外暴露服务，下面将以Deployment为例创建Service。\n创建并执行deployment.yml文件：\napiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:latest ports: - containerPort: 80 kubectl apply -f deployment.yml 创建并执行service.yml文件：\napiVersion: v1 kind: Service metadata: name: nginx-service spec: selector: app: nginx ports: - protocol: TCP port: 8080 targetPort: 80 kubectl apply -f service.yml 上述Service的创建过程与下述命令等效：\nkubectl expose deployment nginx-deployment --name nginx-service --port=8080 --target-port=80 至此，nginx-service服务创建成功，其自动支持了以下功能：\n服务注册：在DNS中写入了nginx-service的记录 服务发现：其它服务调用nginx-service时，会从DNS中获取到对应的Service记录，并根据Service找到Pod的ip 负载均衡：一个Service可以对应多个Pod，访问Service会自动转发到其中某一个Pod 为了验证上述功能，可以进入容器访问对应服务：\nkubectl get pod # 获取pod name kubectl exec -it nginx-deployment-6b7f675859-dn9jj bash # 进入对应的pod容器 curl nginx-service:8080 # 访问nginx-service服务 正常将会返回nginx首页的html文本。\n如果使用minikube，可以使用minikube service命令暴露服务，如下所示：\nminikube service nginx-service 随后浏览器会自动打开nginx首页。\n四、总结 SpringCloud通过Erueka、Nacos等注册中心实现服务注册与服务发现，通过Ribbon、SpringCloudLoadBalancer等负载均衡组件实现客户端的负载均衡。\nK8S通过Service等对象实现服务注册、服务发现以及服务端的负载均衡。\n可以看到，SpringCloud与K8S中的服务注册、服务发现与负载均衡的角度不同：SpringCloud偏向于开发，而K8S则更偏向于运维。纯K8S、纯SpringCloud、以及SpringCloud与K8S混用这三种场景都可能存在，不能说哪个一定更好，只能视情况而定。比如说：技术栈是Java，并且没有专职运维或熟悉K8S的人员，那么SpringCloud就是很好的选择；如果技术栈为Go等语言，或者有容器化部署的需求与能力，则可以考虑更通用的K8S。\n同时，除了服务注册、服务发现以及负载均衡外，SpringCloud与K8S还有其它技术重叠的地方，如：配置管理、服务路由（网关）等等，后续也将继续分析SpringCloud与K8S在微服务中的其它不同用法。\n参考文档\n《深入理解SpringCloud与实战 方剑 著》 SpringCloud官方网站 黑马程序员SpringCloud微服务技术栈教程 K8S官方网站 ","wordCount":"3396","inLanguage":"zh","datePublished":"2023-05-08T10:19:50+08:00","dateModified":"2023-05-08T10:19:50+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8/"},"publisher":{"@type":"Organization","name":"luanrz's blog","logo":{"@type":"ImageObject","url":"https://luanrz.github.io/images/icon.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luanrz.github.io/ accesskey=h title="luanrz's blog (Alt + H)">luanrz's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luanrz.github.io/ title=首页><span>首页</span></a></li><li><a href=https://luanrz.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://luanrz.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://luanrz.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://luanrz.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">SpringCloud与K8S中的服务调用</h1><div class=post-meta><span title='2023-05-08 10:19:50 +0800 +0800'>2023-05-08</span>&nbsp;·&nbsp;7 分钟&nbsp;·&nbsp;3396 字</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%b8%80springcloud%e4%b8%ad%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%8e%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0 aria-label=一、SpringCloud中的服务注册与服务发现>一、SpringCloud中的服务注册与服务发现</a><ul><li><a href=#%e4%b8%80springcloud%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%8e%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e7%bc%96%e7%a8%8b%e6%a8%a1%e5%9e%8b aria-label=（一）SpringCloud服务注册与服务发现编程模型>（一）SpringCloud服务注册与服务发现编程模型</a></li><li><a href=#%e4%ba%8cnacos%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e6%9c%8d%e5%8a%a1 aria-label=（二）Nacos注册中心服务>（二）Nacos注册中心服务</a></li><li><a href=#%e4%b8%89nacos%e6%9c%8d%e5%8a%a1%e6%8f%90%e4%be%9b%e8%80%85 aria-label=（三）Nacos服务提供者>（三）Nacos服务提供者</a></li><li><a href=#%e5%9b%9bnacos%e6%9c%8d%e5%8a%a1%e6%b6%88%e8%b4%b9%e8%80%85 aria-label=（四）Nacos服务消费者>（四）Nacos服务消费者</a></li></ul></li><li><a href=#%e4%ba%8cspringcloud%e4%b8%ad%e7%9a%84%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 aria-label=二、SpringCloud中的负载均衡>二、SpringCloud中的负载均衡</a><ul><li><a href=#%e4%b8%80springcloud%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%bc%96%e7%a8%8b%e6%a8%a1%e5%9e%8b aria-label=（一）SpringCloud负载均衡编程模型>（一）SpringCloud负载均衡编程模型</a></li><li><a href=#%e4%ba%8c%e5%9f%ba%e4%ba%8eloadbalanced%e6%b3%a8%e8%a7%a3%e4%b8%8efeign%e7%bb%84%e4%bb%b6%e5%ae%9e%e7%8e%b0%e5%ae%a2%e6%88%b7%e7%ab%af%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 aria-label=（二）基于@LoadBalanced注解与Feign组件实现客户端负载均衡>（二）基于@LoadBalanced注解与Feign组件实现客户端负载均衡</a></li></ul></li><li><a href=#%e4%b8%89k8s%e4%b8%ad%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e4%b8%8e%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1 aria-label=三、K8S中的服务注册、服务发现与负载均衡>三、K8S中的服务注册、服务发现与负载均衡</a></li><li><a href=#%e5%9b%9b%e6%80%bb%e7%bb%93 aria-label=四、总结>四、总结</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement||=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e}),elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>微服务中的服务调用至少需要考虑以下几个方面：</p><ul><li>服务注册：动态存储服务的访问地址</li><li>服务发现：动态获取服务的访问地址</li><li>负载均衡：按照一定的规则获取同一服务的不同实例</li></ul><p>它们在SpringCloud和K8S中有着不同的实现方式：</p><table><thead><tr><th></th><th>SpringCloud</th><th>K8S</th></tr></thead><tbody><tr><td>服务注册与服务发现</td><td><strong>注册中心</strong>（Erueka、Nacos等）</td><td><strong>Service</strong>（kube-dns）</td></tr><tr><td>负载均衡</td><td><strong>负载均衡组件</strong>（Ribbon、SpringCloudLoadBalancer等）</td><td><strong>Service</strong>（kube-proxy等）</td></tr></tbody></table><p>下面将结合代码分别介绍SpinrgCloud与K8S中服务注册、服务发现、负载均衡的过程。</p><h2 id=一springcloud中的服务注册与服务发现>一、SpringCloud中的服务注册与服务发现<a hidden class=anchor aria-hidden=true href=#一springcloud中的服务注册与服务发现>#</a></h2><h3 id=一springcloud服务注册与服务发现编程模型>（一）SpringCloud服务注册与服务发现编程模型<a hidden class=anchor aria-hidden=true href=#一springcloud服务注册与服务发现编程模型>#</a></h3><p>SpringCloud在<a href=https://spring.io/projects/spring-cloud-commons>SpringCloudCommons</a>模块中定义了服务注册与服务发现的抽象层，如下：</p><ul><li>服务注册接口<code>ServiceRegistry</code></li><li>服务发现接口<code>DiscoveryClient</code></li></ul><p>在maven依赖中引入Eureka或Nacos后，将会基于SpringBoot的工厂加载机制自动加载上述接口的实现：</p><ul><li>服务注册接口<code>ServiceRegistry</code>的实现：<code>EurekaServiceRegistry</code>、<code>NacosServiceRegistry</code></li><li>服务发现接口<code>DiscoveryClient</code>的实现：<code>NacosDiscoveryClient</code>、<code>NacosDiscoveryClient</code>、<code>CompositeDiscoveryClient</code>、<code>SimpleDiscoveryClient</code></li></ul><p>由于组件注入时使用的是<code>ServiceRegistry</code>与<code>DiscoveryClient</code>这两个抽象接口，因此，无须修改代码即可实现不同注册中心的无缝切换，只需要替换maven依赖与对应的注册中心的配置即可。</p><p>下面将基于Nacos演示一下服务注册与服务发现的用法（Eureka的用法完全一致）。</p><h3 id=二nacos注册中心服务>（二）Nacos注册中心服务<a hidden class=anchor aria-hidden=true href=#二nacos注册中心服务>#</a></h3><p>根据<a href=https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html>Nacos官网</a>步骤启动Nacos注册中心。</p><p>访问<code>http://127.0.0.1:8848</code>进入Nacos首页。</p><h3 id=三nacos服务提供者>（三）Nacos服务提供者<a hidden class=anchor aria-hidden=true href=#三nacos服务提供者>#</a></h3><p>在pom.xml中引入nacos-discovery依赖：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在application.properties（或application.yml）中引入nacos相关配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>server.port=8081
</span></span><span style=display:flex><span>spring.application.name=nacos-provider
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.username=nacos
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.password=nacos
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.server-addr=localhost:8848
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.namespace=public
</span></span></code></pre></div><p>定义应用入口并暴露一个服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NacosProviderApplication</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(NacosProviderApplication.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EchoController</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/echo&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>echo</span>(HttpServletRequest request) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;echo:&#34;</span> <span style=color:#f92672>+</span> request.<span style=color:#a6e22e>getParameter</span>(<span style=color:#e6db74>&#34;name&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>上述代码详见<a href=https://github.com/luanrz/spring-cloud-demo/tree/main/service-registry-discovery/nacos-provider>github</a></p></blockquote><p>启动应用后，该服务将自动注册到Nacos注册中心。查看注册中心中该服务的状态：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#39;http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos-provider&#39;</span>  
</span></span></code></pre></div><p>正常返回如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;DEFAULT_GROUP@@nacos-provider&#34;</span>,<span style=color:#f92672>&#34;groupName&#34;</span>:<span style=color:#e6db74>&#34;DEFAULT_GROUP&#34;</span>,<span style=color:#f92672>&#34;clusters&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;cacheMillis&#34;</span>:<span style=color:#ae81ff>10000</span>,<span style=color:#f92672>&#34;hosts&#34;</span>:[{<span style=color:#f92672>&#34;ip&#34;</span>:<span style=color:#e6db74>&#34;172.26.2.233&#34;</span>,<span style=color:#f92672>&#34;port&#34;</span>:<span style=color:#ae81ff>8081</span>,<span style=color:#f92672>&#34;weight&#34;</span>:<span style=color:#ae81ff>1.0</span>,<span style=color:#f92672>&#34;healthy&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;enabled&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;ephemeral&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;clusterName&#34;</span>:<span style=color:#e6db74>&#34;DEFAULT&#34;</span>,<span style=color:#f92672>&#34;serviceName&#34;</span>:<span style=color:#e6db74>&#34;DEFAULT_GROUP@@nacos-provider&#34;</span>,<span style=color:#f92672>&#34;metadata&#34;</span>:{<span style=color:#f92672>&#34;preserved.register.source&#34;</span>:<span style=color:#e6db74>&#34;SPRING_CLOUD&#34;</span>,<span style=color:#f92672>&#34;IPv6&#34;</span>:<span style=color:#e6db74>&#34;[fc00:f853:ccd:e793:0:0:0:1]&#34;</span>},<span style=color:#f92672>&#34;instanceHeartBeatInterval&#34;</span>:<span style=color:#ae81ff>5000</span>,<span style=color:#f92672>&#34;instanceHeartBeatTimeOut&#34;</span>:<span style=color:#ae81ff>15000</span>,<span style=color:#f92672>&#34;ipDeleteTimeout&#34;</span>:<span style=color:#ae81ff>30000</span>}],<span style=color:#f92672>&#34;lastRefTime&#34;</span>:<span style=color:#ae81ff>1683528099856</span>,<span style=color:#f92672>&#34;checksum&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;allIPs&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;reachProtectionThreshold&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;valid&#34;</span>:<span style=color:#66d9ef>true</span>}
</span></span></code></pre></div><h3 id=四nacos服务消费者>（四）Nacos服务消费者<a hidden class=anchor aria-hidden=true href=#四nacos服务消费者>#</a></h3><p>在pom.xml中引入与<a href=#%E4%B8%89nacos%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85>Nacos服务提供者</a>一样的nacos-discovery依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在application.properties（或application.yml）中引入nacos相关配置。除了端口和服务名外，其它配置与<a href=#%E4%B8%89nacos%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85>Nacos服务提供者</a>完全一致。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>server.port=8080
</span></span><span style=display:flex><span>spring.application.name=nacos-consumer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.username=nacos
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.password=nacos
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.server-addr=localhost:8848
</span></span><span style=display:flex><span>spring.cloud.nacos.discovery.namespace=public
</span></span></code></pre></div><p>在代码中通过DiscoveryClient获取<a href=#%E4%B8%89nacos%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85>Nacos服务提供者</a>的实例地址，通过RestTemplate访问。并使用<code>@EnableDiscoveryClient(autoRegister = false)</code>以避免将服务消费者注册到注册中心。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>(autoRegister <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NacosConsumerApplication</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(NacosConsumerApplication.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RestTemplate <span style=color:#a6e22e>restTemplate</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RestTemplate();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloController</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> DiscoveryClient discoveryClient;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> RestTemplate restTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String serviceName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nacos-provider&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/services&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>info</span>() {
</span></span><span style=display:flex><span>            String serviceInfo <span style=color:#f92672>=</span> discoveryClient.<span style=color:#a6e22e>getServices</span>().<span style=color:#a6e22e>toString</span>();
</span></span><span style=display:flex><span>            String instanceInfo <span style=color:#f92672>=</span> discoveryClient.<span style=color:#a6e22e>getInstances</span>(serviceName).<span style=color:#a6e22e>stream</span>().<span style=color:#a6e22e>map</span>(instance <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;InstanceId: &#34;</span> <span style=color:#f92672>+</span> instance.<span style=color:#a6e22e>getInstanceId</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;br&gt;ServiceId: &#34;</span> <span style=color:#f92672>+</span> instance.<span style=color:#a6e22e>getServiceId</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;br&gt;Host: &#34;</span> <span style=color:#f92672>+</span> instance.<span style=color:#a6e22e>getHost</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;br&gt;Port: &#34;</span> <span style=color:#f92672>+</span> instance.<span style=color:#a6e22e>getPort</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;br&gt;&#34;</span>).<span style=color:#a6e22e>collect</span>(Collectors.<span style=color:#a6e22e>joining</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> serviceInfo <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;br&gt;&lt;br&gt;&#34;</span> <span style=color:#f92672>+</span> instanceInfo;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>hello</span>() {
</span></span><span style=display:flex><span>            List<span style=color:#f92672>&lt;</span>ServiceInstance<span style=color:#f92672>&gt;</span> instances <span style=color:#f92672>=</span> discoveryClient.<span style=color:#a6e22e>getInstances</span>(serviceName);
</span></span><span style=display:flex><span>            ServiceInstance serviceInstance <span style=color:#f92672>=</span> instances.<span style=color:#a6e22e>stream</span>().<span style=color:#a6e22e>findAny</span>().<span style=color:#a6e22e>orElseThrow</span>(() <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;no &#34;</span> <span style=color:#f92672>+</span> serviceName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; instance available&#34;</span>));
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> restTemplate.<span style=color:#a6e22e>getForObject</span>(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> serviceInstance.<span style=color:#a6e22e>getHost</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> serviceInstance.<span style=color:#a6e22e>getPort</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/echo?name=nacos&#34;</span>,String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>上述代码详见<a href=https://github.com/luanrz/spring-cloud-demo/tree/main/service-registry-discovery/nacos-consumer>github</a></p></blockquote><p>启动应用后，访问对应服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#39;http://127.0.0.1:8080/hello?name=nacos&#39;</span>
</span></span></code></pre></div><p>正常返回如下：</p><pre tabindex=0><code>echo:nacos
</code></pre><h2 id=二springcloud中的负载均衡>二、SpringCloud中的负载均衡<a hidden class=anchor aria-hidden=true href=#二springcloud中的负载均衡>#</a></h2><h3 id=一springcloud负载均衡编程模型>（一）SpringCloud负载均衡编程模型<a hidden class=anchor aria-hidden=true href=#一springcloud负载均衡编程模型>#</a></h3><p>SpringCloud在<a href=https://spring.io/projects/spring-cloud-commons>SpringCloudCommons</a>模块中定义了负载均衡的抽象层：<code>LoadBalancerClient</code>与<code>LoadBalanced</code>。</p><p><code>LoadBalancerClient</code>的实现有：基于Ribbon的<code>RibbonLoadBalancerClient</code>、基于SpringCloudLoadBalancer的<code>BlockingLoadBalancerClient</code>。</p><h3 id=二基于loadbalanced注解与feign组件实现客户端负载均衡>（二）基于@LoadBalanced注解与Feign组件实现客户端负载均衡<a hidden class=anchor aria-hidden=true href=#二基于loadbalanced注解与feign组件实现客户端负载均衡>#</a></h3><p>在pom.xml中引入Feign、服务发现与负载均衡的依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!-- OpenFeign --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 服务发现组件 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 该组件依赖了SpringCloudLoadBalancer组件（老版本为Ribbon）来实现负载均衡 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 如果将负载均衡交给K8S，就没有必要引入客户端负载均衡组件了，直接将@FeignClient的url指向K8S的Service地址即可 --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!-- 负载均衡组件（Feign需要） --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-loadbalancer<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在application.properties（或application.yml）中引入nacos相关配置。该配置与<a href=#%E5%9B%9Bnacos%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85>Nacos服务消费者</a>完全一致。</p><pre tabindex=0><code>server.port=8080
spring.application.name=open-feign

spring.cloud.nacos.discovery.username=nacos
spring.cloud.nacos.discovery.password=nacos
spring.cloud.nacos.discovery.server-addr=localhost:8848
spring.cloud.nacos.discovery.namespace=public
</code></pre><p>定义Feign服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nacos-provider&#34;</span>) <span style=color:#75715e>// url = &#34;http://localhost:8081&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>EchoApi</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/echo&#34;</span>)
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>echo</span>(<span style=color:#a6e22e>@RequestParam</span>(<span style=color:#e6db74>&#34;name&#34;</span>) String name);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>定义应用入口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenFeignApplication</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(OpenFeignApplication.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloController</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>        EchoApi echoApi;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>hello</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> echoApi.<span style=color:#a6e22e>echo</span>(<span style=color:#e6db74>&#34;nacos&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>上述代码详见<a href=https://github.com/luanrz/spring-cloud-demo/tree/main/service-invocation/open-feign>github</a></p></blockquote><p>停止<a href=#%E4%B8%89nacos%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85>Nacos服务提供者</a>与<a href=#%E5%9B%9Bnacos%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85>Nacos服务消费者</a>两个应用。随后启动三个<a href=#%E4%B8%89nacos%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85>Nacos服务提供者</a>应用（修改server.port环境变量），再启动当前应用，验证负载均衡效果。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#39;http://127.0.0.1:8080/hello?name=nacos&#39;</span>
</span></span></code></pre></div><p>正常返回如下：</p><pre tabindex=0><code>echo:nacos
</code></pre><p>查看三个<a href=#%E4%B8%89nacos%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85>Nacos服务提供者</a>的控制台日志，多次调用会在不同的应用控制台显示相关信息。</p><h2 id=三k8s中的服务注册服务发现与负载均衡>三、K8S中的服务注册、服务发现与负载均衡<a hidden class=anchor aria-hidden=true href=#三k8s中的服务注册服务发现与负载均衡>#</a></h2><p>K8S通过Service对象定义一个服务，一旦Service定义成功，就自动支持了服务注册、服务发现与负载均衡。Service可以基于Pod、Deployment、另外一个Service等对象对外暴露服务，下面将以Deployment为例创建Service。</p><p>创建并执行<code>deployment.yml</code>文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-deployment</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f deployment.yml
</span></span></code></pre></div><p>创建并执行<code>service.yml</code>文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>nginx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f service.yml 
</span></span></code></pre></div><p>上述Service的创建过程与下述命令等效：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl expose deployment nginx-deployment --name nginx-service --port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span> --target-port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span>
</span></span></code></pre></div><p>至此，nginx-service服务创建成功，其自动支持了以下功能：</p><ul><li>服务注册：在DNS中写入了nginx-service的记录</li><li>服务发现：其它服务调用nginx-service时，会从DNS中获取到对应的Service记录，并根据Service找到Pod的ip</li><li>负载均衡：一个Service可以对应多个Pod，访问Service会自动转发到其中某一个Pod</li></ul><p>为了验证上述功能，可以进入容器访问对应服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get pod <span style=color:#75715e># 获取pod name</span>
</span></span><span style=display:flex><span>kubectl exec -it nginx-deployment-6b7f675859-dn9jj bash <span style=color:#75715e># 进入对应的pod容器</span>
</span></span><span style=display:flex><span>curl nginx-service:8080 <span style=color:#75715e># 访问nginx-service服务</span>
</span></span></code></pre></div><p>正常将会返回nginx首页的html文本。</p><p>如果使用minikube，可以使用<code>minikube service</code>命令暴露服务，如下所示：</p><pre tabindex=0><code>minikube service nginx-service
</code></pre><p>随后浏览器会自动打开nginx首页。</p><h2 id=四总结>四、总结<a hidden class=anchor aria-hidden=true href=#四总结>#</a></h2><p>SpringCloud通过Erueka、Nacos等注册中心实现服务注册与服务发现，通过Ribbon、SpringCloudLoadBalancer等负载均衡组件实现客户端的负载均衡。</p><p>K8S通过Service等对象实现服务注册、服务发现以及服务端的负载均衡。</p><p>可以看到，SpringCloud与K8S中的服务注册、服务发现与负载均衡的角度不同：SpringCloud偏向于开发，而K8S则更偏向于运维。纯K8S、纯SpringCloud、以及SpringCloud与K8S混用这三种场景都可能存在，不能说哪个一定更好，只能视情况而定。比如说：技术栈是Java，并且没有专职运维或熟悉K8S的人员，那么SpringCloud就是很好的选择；如果技术栈为Go等语言，或者有容器化部署的需求与能力，则可以考虑更通用的K8S。</p><p>同时，除了服务注册、服务发现以及负载均衡外，SpringCloud与K8S还有其它技术重叠的地方，如：配置管理、服务路由（网关）等等，后续也将继续分析SpringCloud与K8S在微服务中的其它不同用法。</p><blockquote><p>参考文档</p></blockquote><ol><li>《深入理解SpringCloud与实战 方剑 著》</li><li><a href=https://spring.io/projects/spring-cloud/>SpringCloud官方网站</a></li><li><a href=https://www.bilibili.com/video/BV1LQ4y127n4>黑马程序员SpringCloud微服务技术栈教程</a></li><li><a href=https://kubernetes.io/zh-cn/>K8S官方网站</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://luanrz.github.io/tags/java/>Java</a></li><li><a href=https://luanrz.github.io/tags/spring/>Spring</a></li></ul><nav class=paginav><a class=prev href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/><span class=title>« 上一页</span><br><span>SpringCloud与K8S中的配置管理</span>
</a><a class=next href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springdata%E5%85%A5%E9%97%A8/><span class=title>下一页 »</span><br><span>SpringData入门</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://luanrz.github.io/>luanrz's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>