<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SpringCloud与K8S中的配置管理 | luanrz's blog</title><meta name=keywords content="Java,Spring"><meta name=description content="微服务中的配置管理在SpringCloud和K8S中有着不同的实现方式：

  
      
          
          SpringCloud
          K8S
      
  
  
      
          配置管理
          配置中心（SpringCloudConfig、Nacos等）
          ConfigMap、Secret等
      
  

下面将基于Nacos与ConfigMap分别介绍SpinrgCloud与K8S中配置管理的过程。"><meta name=author content><link rel=canonical href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/><link crossorigin=anonymous href=/assets/css/stylesheet.ed6c30fee125be816b653632a2732f92313b593583d98576c9eb2bf33a42b6e1.css integrity="sha256-7Www/uElvoFrZTYyonMvkjE7WTWD2YV2yesr8zpCtuE=" rel="preload stylesheet" as=style><link rel=icon href=https://luanrz.github.io/images/icon.jpg><link rel=icon type=image/png sizes=16x16 href=https://luanrz.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://luanrz.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://luanrz.github.io/apple-touch-icon.png><link rel=mask-icon href=https://luanrz.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>const loadScript=(e,t)=>{var n=document.createElement("script");n.onerror=e=>{throw new URIError("The script "+e.target.src+" didn't load correctly.")},t&&(n.onload=t),document.head.insertAdjacentElement("beforeend",n),n.src=e},loadPlantUMLOnNeed=()=>{let e="language-plantuml";document.querySelectorAll("[class^="+e+"]").length>0&&loadScript("https://fastly.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js",()=>{(function(){Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.insertBefore(t,e),e.style.display="none"})})(),console.log("PlantUML init done")})};window.addEventListener("load",function(){loadPlantUMLOnNeed()})</script><meta property="og:url" content="https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"><meta property="og:site_name" content="luanrz's blog"><meta property="og:title" content="SpringCloud与K8S中的配置管理"><meta property="og:description" content="微服务中的配置管理在SpringCloud和K8S中有着不同的实现方式：
SpringCloud K8S 配置管理 配置中心（SpringCloudConfig、Nacos等） ConfigMap、Secret等 下面将基于Nacos与ConfigMap分别介绍SpinrgCloud与K8S中配置管理的过程。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-10T20:00:00+08:00"><meta property="article:modified_time" content="2023-05-10T20:00:00+08:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="Spring"><meta name=twitter:card content="summary"><meta name=twitter:title content="SpringCloud与K8S中的配置管理"><meta name=twitter:description content="微服务中的配置管理在SpringCloud和K8S中有着不同的实现方式：

  
      
          
          SpringCloud
          K8S
      
  
  
      
          配置管理
          配置中心（SpringCloudConfig、Nacos等）
          ConfigMap、Secret等
      
  

下面将基于Nacos与ConfigMap分别介绍SpinrgCloud与K8S中配置管理的过程。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://luanrz.github.io/posts/"},{"@type":"ListItem","position":3,"name":"SpringCloud与K8S中的配置管理","item":"https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SpringCloud与K8S中的配置管理","name":"SpringCloud与K8S中的配置管理","description":"微服务中的配置管理在SpringCloud和K8S中有着不同的实现方式：\nSpringCloud K8S 配置管理 配置中心（SpringCloudConfig、Nacos等） ConfigMap、Secret等 下面将基于Nacos与ConfigMap分别介绍SpinrgCloud与K8S中配置管理的过程。\n","keywords":["Java","Spring"],"articleBody":"微服务中的配置管理在SpringCloud和K8S中有着不同的实现方式：\nSpringCloud K8S 配置管理 配置中心（SpringCloudConfig、Nacos等） ConfigMap、Secret等 下面将基于Nacos与ConfigMap分别介绍SpinrgCloud与K8S中配置管理的过程。\n一、SpringCloud中的配置管理 （一）Nacos配置中心服务 根据Nacos官网步骤启动Nacos配置中心。\n访问http://127.0.0.1:8848进入Nacos首页。\n随后在配置管理页面新建一个配置，Data ID填写nacos-config.yaml，配置格式勾选YAML，配置内容编辑如下：\nswitch: fun1: false 至此，一个独立于应用的远程配置已经定义好了，该配置控制了fun1这个功能的启用状态，接下来将在客户端读取此项配置以实现流程控制。\n（二）配置获取与动态刷新 在pom.xml中导入nacos-config相关依赖。\norg.springframework.boot spring-boot-starter-web com.alibaba.cloud spring-cloud-starter-alibaba-nacos-config org.springframework.cloud spring-cloud-starter-bootstrap 在resources下新增bootstrap.yml配置文件。\nserver: port: 8180 spring: application: name: nacos-config cloud: nacos: config: file-extension: yaml server-addr: 127.0.0.1:8848 这里之所以使用bootstrap.yml而不是application.yaml，是因为bootstrap优先于application加载，其配置优先级更高，保证了远程配置中心的配置永远在本地配置文件中的配置之前生效。\n该文件通过server-addr指定了nacos配置中心的地址，应用启动后，会在对应的配置中心中寻找Data ID为nacos-config.yaml且配置格式为YAML的配置项（正如上述Nacos配置中心服务中配置的一样）。\nSpringBoot可以使用@Value或ConfigurationProperties读取配置，它们本质都是读取Environment中的值，下面将基于这两种方式分别演示Nacos配置的读取。新建入口程序如下：\n@RestController @RefreshScope public class NacosConfigController { // 注入Nacos配置方式一：Value @Value(\"${switch.fun1:false}\") private boolean fun1Switch; // 注入Nacos配置方式二：ConfigurationProperties @Autowired private FunSwitchProperties properties; @GetMapping(\"/value\") public String value() { return dealFun1(fun1Switch); } @GetMapping(\"/properties\") public String properties() { return dealFun1(properties.getFun1()); } private String dealFun1(boolean theSwitch) { if (theSwitch) { return \"do fun1\"; } else { return \"do nothing\"; } } @ConfigurationProperties(prefix = \"switch\") @Component public static class FunSwitchProperties { private boolean fun1; public boolean getFun1() { return fun1; } public void setFun1(boolean fun1) { this.fun1 = fun1; } } } @SpringBootApplication public class NacosConfigApplication { public static void main(String[] args) { SpringApplication.run(NacosConfigApplication.class, args); } } 上述代码详见github\n启动应用，访问服务：\ncurl -X GET 'http://127.0.0.1:8180/value' curl -X GET 'http://127.0.0.1:8180/properties' 它们的响应结果都是：\ndo nothing 这符合预期，因为现在switch.fun1的本地默认值和Nacos配置的值都是false，下面，在Nacos页面修改对应的配置：\nswitch: fun1: true 此时应用控制台打印如下日志，说明配置刷新成功。\nLocated property source: [BootstrapPropertySource {name='bootstrapProperties-nacos-config.yaml,DEFAULT_GROUP'}, BootstrapPropertySource {name='bootstrapProperties-nacos-config,DEFAULT_GROUP'}] 再次访问服务：\ncurl -X GET 'http://127.0.0.1:8180/value' curl -X GET 'http://127.0.0.1:8180/properties' 它们的响应结果变成了：\ndo fun1 可以看到，配置获取与动态刷新都正常运行了。\n二、K8S中的配置管理 K8S的配置管理主要由ConfigMap和Secret组成，其中，ConfigMap用于保存非机密性数据，Secret则用于保存敏感数据。它们的使用方法很类似，下面以ConfigMap为例介绍K8S的配置管理。\n（一）创建ConfigMap 创建并执行configmap.yml文件：\napiVersion: v1 kind: ConfigMap metadata: name: configmap-demo data: key: \"value\" kubectl apply -f configmap.yml 查看创建成功的ConfigMap：\nkubectl get cm kubectl describe cm configmap-demo Name: configmap-demo Namespace: default Labels: Annotations: Data ==== key: ---- value BinaryData ==== Events: 可以看到，该ConfigMap中存在了一个key-value配置，下面将在pod中使用它。\n（二）使用ConfigMap实现配置获取与动态刷新 创建并执行pod.yml文件：\napiVersion: v1 kind: Pod metadata: name: configmap-demo-pod spec: containers: - name: demo image: alpine command: [\"sleep\", \"3600\"] # env方式获取configmap env: - name: KEY valueFrom: configMapKeyRef: name: configmap-demo key: key # volumeMounts方式获取configmap volumeMounts: - name: config mountPath: \"/config\" readOnly: true volumes: - name: config configMap: name: configmap-demo kubectl apply -f pod.yml 查看Pod中的环境变量与挂载文件的值：\nkubectl exec configmap-demo-pod -- env kubectl exec configmap-demo-pod -- cat /config/key 它们key的值都是value，说明配置的获取正常运行了。\n随后，修改ConfigMap中的值：\nkubectl edit cm configmap-demo 将value修改为newvalue，随后等待片刻，挂载的ConfigMap将会被自动更新。再次查看Pod中挂载文件的值：\nkubectl exec configmap-demo-pod -- cat /config/key 可以发现，key的值已经变成了newvalue，说明配置的动态刷新也正常运行了（需要注意的是，环境变量不会动态刷新）。\n三、总结 SpringCloud通过SpringCloudConfig、Nacos等配置中心实现配置获取与动态刷新。\nK8S通过ConfigMap与Secret对象实现配置获取与动态刷新。\n与SpringCloud与K8S中的服务调用中类似：SpringCloud偏向于开发，而K8S则更偏向于运维。有关技术选型，需视情况而定。\n参考文档\n《深入理解SpringCloud与实战 方剑 著》 SpringCloud官方网站 黑马程序员SpringCloud微服务技术栈教程 K8S官方网站 ","wordCount":"1986","inLanguage":"zh","datePublished":"2023-05-10T20:00:00+08:00","dateModified":"2023-05-10T20:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"},"publisher":{"@type":"Organization","name":"luanrz's blog","logo":{"@type":"ImageObject","url":"https://luanrz.github.io/images/icon.jpg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://luanrz.github.io/ accesskey=h title="luanrz's blog (Alt + H)">luanrz's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://luanrz.github.io/ title=首页><span>首页</span></a></li><li><a href=https://luanrz.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li><li><a href=https://luanrz.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://luanrz.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://luanrz.github.io/tags/ title=标签><span>标签</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">SpringCloud与K8S中的配置管理</h1><div class=post-meta><span title='2023-05-10 20:00:00 +0800 +0800'>2023-05-10</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;1986 字</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%b8%80springcloud%e4%b8%ad%e7%9a%84%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86 aria-label=一、SpringCloud中的配置管理>一、SpringCloud中的配置管理</a><ul><li><a href=#%e4%b8%80nacos%e9%85%8d%e7%bd%ae%e4%b8%ad%e5%bf%83%e6%9c%8d%e5%8a%a1 aria-label=（一）Nacos配置中心服务>（一）Nacos配置中心服务</a></li><li><a href=#%e4%ba%8c%e9%85%8d%e7%bd%ae%e8%8e%b7%e5%8f%96%e4%b8%8e%e5%8a%a8%e6%80%81%e5%88%b7%e6%96%b0 aria-label=（二）配置获取与动态刷新>（二）配置获取与动态刷新</a></li></ul></li><li><a href=#%e4%ba%8ck8s%e4%b8%ad%e7%9a%84%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86 aria-label=二、K8S中的配置管理>二、K8S中的配置管理</a><ul><li><a href=#%e4%b8%80%e5%88%9b%e5%bb%baconfigmap aria-label=（一）创建ConfigMap>（一）创建ConfigMap</a></li><li><a href=#%e4%ba%8c%e4%bd%bf%e7%94%a8configmap%e5%ae%9e%e7%8e%b0%e9%85%8d%e7%bd%ae%e8%8e%b7%e5%8f%96%e4%b8%8e%e5%8a%a8%e6%80%81%e5%88%b7%e6%96%b0 aria-label=（二）使用ConfigMap实现配置获取与动态刷新>（二）使用ConfigMap实现配置获取与动态刷新</a></li></ul></li><li><a href=#%e4%b8%89%e6%80%bb%e7%bb%93 aria-label=三、总结>三、总结</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement||=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e}),elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>微服务中的配置管理在SpringCloud和K8S中有着不同的实现方式：</p><table><thead><tr><th></th><th>SpringCloud</th><th>K8S</th></tr></thead><tbody><tr><td>配置管理</td><td><strong>配置中心</strong>（SpringCloudConfig、Nacos等）</td><td><strong>ConfigMap、Secret</strong>等</td></tr></tbody></table><p>下面将基于<code>Nacos</code>与<code>ConfigMap</code>分别介绍SpinrgCloud与K8S中配置管理的过程。</p><h2 id=一springcloud中的配置管理>一、SpringCloud中的配置管理<a hidden class=anchor aria-hidden=true href=#一springcloud中的配置管理>#</a></h2><h3 id=一nacos配置中心服务>（一）Nacos配置中心服务<a hidden class=anchor aria-hidden=true href=#一nacos配置中心服务>#</a></h3><p>根据<a href=https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html>Nacos官网</a>步骤启动Nacos配置中心。</p><p>访问<code>http://127.0.0.1:8848</code>进入Nacos首页。</p><p>随后在配置管理页面新建一个配置，<code>Data ID</code>填写<code>nacos-config.yaml</code>，配置格式勾选<code>YAML</code>，配置内容编辑如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>switch</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>fun1</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>至此，一个独立于应用的远程配置已经定义好了，该配置控制了fun1这个功能的启用状态，接下来将在客户端读取此项配置以实现流程控制。</p><h3 id=二配置获取与动态刷新>（二）配置获取与动态刷新<a hidden class=anchor aria-hidden=true href=#二配置获取与动态刷新>#</a></h3><p>在<code>pom.xml</code>中导入<code>nacos-config</code>相关依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependencies&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!-- 新版本SpringCloud需要手动导入bootstrap以启动bootstrap.yml配置 --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-bootstrap<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>在resources下新增<code>bootstrap.yml</code>配置文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8180</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nacos-config</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>file-extension</span>: <span style=color:#ae81ff>yaml</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>8848</span>
</span></span></code></pre></div><p>这里之所以使用<code>bootstrap.yml</code>而不是<code>application.yaml</code>，是因为bootstrap优先于application加载，其配置优先级更高，保证了远程配置中心的配置永远在本地配置文件中的配置之前生效。</p><p>该文件通过<code>server-addr</code>指定了nacos配置中心的地址，应用启动后，会在对应的配置中心中寻找<code>Data ID</code>为<code>nacos-config.yaml</code>且配置格式为<code>YAML</code>的配置项（正如上述<a href=#%E4%B8%80nacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%9C%8D%E5%8A%A1>Nacos配置中心服务</a>中配置的一样）。</p><p>SpringBoot可以使用<code>@Value</code>或<code>ConfigurationProperties</code>读取配置，它们本质都是读取<code>Environment</code>中的值，下面将基于这两种方式分别演示Nacos配置的读取。新建入口程序如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RefreshScope</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NacosConfigController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注入Nacos配置方式一：Value</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${switch.fun1:false}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> fun1Switch;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注入Nacos配置方式二：ConfigurationProperties</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> FunSwitchProperties properties;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/value&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>value</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dealFun1(fun1Switch);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/properties&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>properties</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dealFun1(properties.<span style=color:#a6e22e>getFun1</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>dealFun1</span>(<span style=color:#66d9ef>boolean</span> theSwitch) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (theSwitch) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;do fun1&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;do nothing&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConfigurationProperties</span>(prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;switch&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FunSwitchProperties</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> fun1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>getFun1</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> fun1;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setFun1</span>(<span style=color:#66d9ef>boolean</span> fun1) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>fun1</span> <span style=color:#f92672>=</span> fun1;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NacosConfigApplication</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(NacosConfigApplication.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>上述代码详见<a href=https://github.com/luanrz/spring-cloud-demo/tree/main/configuration/nacos-config>github</a></p></blockquote><p>启动应用，访问服务：</p><pre tabindex=0><code>curl -X GET &#39;http://127.0.0.1:8180/value&#39;
curl -X GET &#39;http://127.0.0.1:8180/properties&#39;
</code></pre><p>它们的响应结果都是：</p><pre tabindex=0><code>do nothing
</code></pre><p>这符合预期，因为现在<code>switch.fun1</code>的本地默认值和Nacos配置的值都是<code>false</code>，下面，在Nacos页面修改对应的配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>switch</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>fun1</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>此时应用控制台打印如下日志，说明配置刷新成功。</p><pre tabindex=0><code>Located property source: [BootstrapPropertySource {name=&#39;bootstrapProperties-nacos-config.yaml,DEFAULT_GROUP&#39;}, BootstrapPropertySource {name=&#39;bootstrapProperties-nacos-config,DEFAULT_GROUP&#39;}]
</code></pre><p>再次访问服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#39;http://127.0.0.1:8180/value&#39;</span>
</span></span><span style=display:flex><span>curl -X GET <span style=color:#e6db74>&#39;http://127.0.0.1:8180/properties&#39;</span>
</span></span></code></pre></div><p>它们的响应结果变成了：</p><pre tabindex=0><code>do fun1
</code></pre><p>可以看到，配置获取与动态刷新都正常运行了。</p><h2 id=二k8s中的配置管理>二、K8S中的配置管理<a hidden class=anchor aria-hidden=true href=#二k8s中的配置管理>#</a></h2><p>K8S的配置管理主要由<code>ConfigMap</code>和<code>Secret</code>组成，其中，<code>ConfigMap</code>用于保存非机密性数据，<code>Secret</code>则用于保存敏感数据。它们的使用方法很类似，下面以<code>ConfigMap</code>为例介绍K8S的配置管理。</p><h3 id=一创建configmap>（一）创建ConfigMap<a hidden class=anchor aria-hidden=true href=#一创建configmap>#</a></h3><p>创建并执行<code>configmap.yml</code>文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>configmap-demo</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;value&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f configmap.yml
</span></span></code></pre></div><p>查看创建成功的ConfigMap：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get cm 
</span></span><span style=display:flex><span>kubectl describe cm configmap-demo
</span></span></code></pre></div><pre tabindex=0><code>Name:         configmap-demo
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
key:
----
value

BinaryData
====

Events:  &lt;none&gt;
</code></pre><p>可以看到，该ConfigMap中存在了一个key-value配置，下面将在pod中使用它。</p><h3 id=二使用configmap实现配置获取与动态刷新>（二）使用ConfigMap实现配置获取与动态刷新<a hidden class=anchor aria-hidden=true href=#二使用configmap实现配置获取与动态刷新>#</a></h3><p>创建并执行<code>pod.yml</code>文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>configmap-demo-pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>demo</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alpine</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;sleep&#34;</span>, <span style=color:#e6db74>&#34;3600&#34;</span>]
</span></span><span style=display:flex><span>      <span style=color:#75715e># env方式获取configmap</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>KEY</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>configMapKeyRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>configmap-demo</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>key</span>: <span style=color:#ae81ff>key</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># volumeMounts方式获取configmap</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/config&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>config</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>configMap</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>configmap-demo</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f pod.yml
</span></span></code></pre></div><p>查看Pod中的环境变量与挂载文件的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl exec configmap-demo-pod -- env
</span></span><span style=display:flex><span>kubectl exec configmap-demo-pod -- cat /config/key
</span></span></code></pre></div><p>它们key的值都是<code>value</code>，说明配置的获取正常运行了。</p><p>随后，修改ConfigMap中的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl edit cm configmap-demo
</span></span></code></pre></div><p>将<code>value</code>修改为<code>newvalue</code>，随后等待片刻，挂载的ConfigMap将会被自动更新。再次查看Pod中挂载文件的值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl exec configmap-demo-pod -- cat /config/key
</span></span></code></pre></div><p>可以发现，key的值已经变成了<code>newvalue</code>，说明配置的动态刷新也正常运行了（需要注意的是，环境变量不会动态刷新）。</p><h2 id=三总结>三、总结<a hidden class=anchor aria-hidden=true href=#三总结>#</a></h2><p>SpringCloud通过SpringCloudConfig、Nacos等配置中心实现配置获取与动态刷新。</p><p>K8S通过ConfigMap与Secret对象实现配置获取与动态刷新。</p><p>与SpringCloud与K8S中的服务调用中类似：SpringCloud偏向于开发，而K8S则更偏向于运维。有关技术选型，需视情况而定。</p><blockquote><p>参考文档</p></blockquote><ol><li>《深入理解SpringCloud与实战 方剑 著》</li><li><a href=https://spring.io/projects/spring-cloud/>SpringCloud官方网站</a></li><li><a href=https://www.bilibili.com/video/BV1LQ4y127n4>黑马程序员SpringCloud微服务技术栈教程</a></li><li><a href=https://kubernetes.io/zh-cn/>K8S官方网站</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://luanrz.github.io/tags/java/>Java</a></li><li><a href=https://luanrz.github.io/tags/spring/>Spring</a></li></ul><nav class=paginav><a class=prev href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/><span class=title>« 上一页</span><br><span>SpringCloud与K8S中的服务网关</span>
</a><a class=next href=https://luanrz.github.io/posts/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/springcloud%E4%B8%8Ek8s%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8/><span class=title>下一页 »</span><br><span>SpringCloud与K8S中的服务调用</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://luanrz.github.io/>luanrz's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>